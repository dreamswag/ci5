# ═══════════════════════════════════════════════════════════════════════════
# CI5 PHOENIX — Network Performance Tuning
# /etc/sysctl.d/99-ci5-network.conf
# ═══════════════════════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────────────────────
# TCP/UDP BUFFER SIZES
# Larger buffers = better throughput for high-bandwidth connections
# ─────────────────────────────────────────────────────────────────────────────
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.core.rmem_default = 1048576
net.core.wmem_default = 1048576
net.ipv4.tcp_rmem = 4096 1048576 16777216
net.ipv4.tcp_wmem = 4096 1048576 16777216
net.ipv4.udp_rmem_min = 8192
net.ipv4.udp_wmem_min = 8192

# ─────────────────────────────────────────────────────────────────────────────
# TCP OPTIMIZATION
# ─────────────────────────────────────────────────────────────────────────────
# TCP Fast Open (reduce latency on repeated connections)
net.ipv4.tcp_fastopen = 3

# Reuse TIME_WAIT sockets (improves connection handling)
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 15

# Keepalive (detect dead connections faster)
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_keepalive_intvl = 15

# Backlog queue
net.ipv4.tcp_max_syn_backlog = 8192
net.core.somaxconn = 8192
net.core.netdev_max_backlog = 16384

# Don't slow down after idle
net.ipv4.tcp_slow_start_after_idle = 0

# MTU probing (helps with path MTU discovery issues)
net.ipv4.tcp_mtu_probing = 1

# ─────────────────────────────────────────────────────────────────────────────
# CONGESTION CONTROL — BBR + FQ
# BBR is Google's congestion control, dramatically improves throughput
# FQ (Fair Queueing) provides better packet scheduling
# ─────────────────────────────────────────────────────────────────────────────
net.ipv4.tcp_congestion_control = bbr
net.core.default_qdisc = fq

# ─────────────────────────────────────────────────────────────────────────────
# FORWARDING (Router Mode)
# ─────────────────────────────────────────────────────────────────────────────
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1

# ─────────────────────────────────────────────────────────────────────────────
# CONNTRACK (Connection Tracking)
# Higher limits prevent "table full" errors under heavy load
# ─────────────────────────────────────────────────────────────────────────────
net.netfilter.nf_conntrack_max = 262144
net.netfilter.nf_conntrack_tcp_timeout_established = 7200
net.netfilter.nf_conntrack_udp_timeout = 60
net.netfilter.nf_conntrack_udp_timeout_stream = 180

# ─────────────────────────────────────────────────────────────────────────────
# ARP/NEIGHBOR TABLE
# Prevent "neighbor table overflow" on busy networks
# ─────────────────────────────────────────────────────────────────────────────
net.ipv4.neigh.default.gc_thresh1 = 1024
net.ipv4.neigh.default.gc_thresh2 = 4096
net.ipv4.neigh.default.gc_thresh3 = 8192

# ─────────────────────────────────────────────────────────────────────────────
# MISC
# ─────────────────────────────────────────────────────────────────────────────
# Increase max open files
fs.file-max = 2097152

# Better memory management under load
vm.swappiness = 10
