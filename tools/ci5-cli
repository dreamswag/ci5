#!/bin/bash
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CI5 CLI â€” Hardware Identity & Community Bridge
# Policy: 
#   - Fetch/Update/Install: OPEN (No Auth Required)
#   - Link/Verify/Vote:     RESTRICTED (Identity Required)
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -euo pipefail

# Configuration
CI5_API="https://api.ci5.network"
CI5_IDENTITY="/etc/ci5/.hwid"
CI5_TOKEN="/etc/ci5/.github_token"
CI5_SOURCES="/etc/ci5/sources.list"
CI5_CACHE="/tmp/ci5_registry_composite.json"
GITHUB_CLIENT_ID="Ov23lisWq6nuhqFog2xr"
OFFICIAL_REGISTRY="https://ci5.dev/corks.json"
CORK_DIR="/opt/ci5/corks"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# IDENTITY CORE
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

get_hwid() {
    [ -f "$CI5_IDENTITY" ] && cat "$CI5_IDENTITY" || echo ""
}

get_token() {
    [ -f "$CI5_TOKEN" ] && cat "$CI5_TOKEN" || echo ""
}

check_identity() {
    HWID=$(get_hwid)
    if [ -z "$HWID" ]; then
        echo -e "${RED}Error: Ci5 identity not initialized.${NC}"
        echo "Run 'ci5 link' to generate/link identity."
        exit 1
    fi
}

ensure_dependencies() {
    for cmd in jq curl sha256sum git; do
        if ! command -v $cmd >/dev/null; then
            echo "Installing dependency: $cmd..."
            if command -v opkg >/dev/null; then
                opkg update && opkg install $cmd coreutils-sha256sum git-http >/dev/null
            elif command -v apt-get >/dev/null; then
                sudo apt-get update && sudo apt-get install -y $cmd >/dev/null
            fi
        fi
    done
}

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# OPEN COMMANDS (No Auth)
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# UPDATE: Fetches the registry JSON. Open to all.
update_registry() {
    [ ! -d "$(dirname $CI5_SOURCES)" ] && mkdir -p "$(dirname $CI5_SOURCES)"
    [ ! -f "$CI5_SOURCES" ] && echo "$OFFICIAL_REGISTRY" > "$CI5_SOURCES"
    
    echo "ðŸ”„ Fetching Corks..."
    echo '{"official":{}, "community":{}}' > "$CI5_CACHE"
    
    while IFS= read -r URL || [ -n "$URL" ]; do
        [[ "$URL" =~ ^#.*$ ]] || [[ -z "$URL" ]] && continue
        FETCHED=$(curl -s --max-time 5 "$URL")
        if echo "$FETCHED" | jq empty >/dev/null 2>&1; then
            jq -s '.[0] * ..[1]' "$CI5_CACHE" <(echo "$FETCHED") > "${CI5_CACHE}.tmp" && mv "${CI5_CACHE}.tmp" "$CI5_CACHE"
        fi
    done < "$CI5_SOURCES"
    echo -e "${GREEN}Registry Updated.${NC}"
}

# INSTALL: Clones and runs a cork. Open to all.
cmd_install() {
    CORK_NAME="$1"
    if [ -z "$CORK_NAME" ]; then
        echo "Usage: ci5 install <author/cork-name>"
        exit 1
    fi

    # Auto-update if cache missing
    [ ! -f "$CI5_CACHE" ] && update_registry
    
    # Lookup repo in registry (simple grep/jq approach or direct assumption)
    # For robustness, we assume GitHub structure if not in registry
    REPO_URL="https://github.com/${CORK_NAME}.git"
    TARGET_DIR="$CORK_DIR/$(basename $CORK_NAME)"
    
    echo -e "${CYAN}ðŸ“¦ Installing ${CORK_NAME}...${NC}"
    
    mkdir -p "$CORK_DIR"
    
    if [ -d "$TARGET_DIR" ]; then
        echo "   Updating existing installation..."
        cd "$TARGET_DIR" && git pull
    else
        echo "   Cloning repository..."
        git clone --depth 1 "$REPO_URL" "$TARGET_DIR" || {
            echo -e "${RED}Error: Failed to fetch cork.${NC}"
            exit 1
        }
    fi
    
    # Launch logic
    if [ -f "$TARGET_DIR/docker-compose.yml" ]; then
        echo "   Starting Docker stack..."
        cd "$TARGET_DIR" && docker compose up -d
        echo -e "${GREEN}âœ… Cork installed and running.${NC}"
    elif [ -f "$TARGET_DIR/init.sh" ]; then
        echo "   Running init script..."
        bash "$TARGET_DIR/init.sh"
        echo -e "${GREEN}âœ… Cork initialized.${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Cork fetched, but no launch method found.${NC}"
    fi
}

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# RESTRICTED COMMANDS (Identity Required)
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

cmd_link() {
    # Ensure local ID exists
    if [ -z "$(get_hwid)" ]; then
        echo "Initializing Identity..."
        mkdir -p "/etc/ci5"
        SERIAL=$(grep -i "^Serial" /proc/cpuinfo | awk '{print $3}' | head -1)
        [ -z "$SERIAL" ] && SERIAL="UNKNOWN_$(cat /sys/class/net/eth0/address | tr -d ':')"
        echo -n "${SERIAL}:ci5-permanent-identity-v1" | sha256sum | cut -d' ' -f1 > "$CI5_IDENTITY"
    fi

    HWID=$(get_hwid)
    echo -e "${CYAN}ðŸ”— Ci5 Identity Link${NC}"
    echo "HWID: ${GREEN}${HWID:0:8}...${NC}"
    
    echo "Requesting GitHub Device Code..."
    DEVICE_RESPONSE=$(curl -s -X POST "https://github.com/login/device/code" \
        -H "Accept: application/json" -d "client_id=${GITHUB_CLIENT_ID}&scope=public_repo")
    
    DEVICE_CODE=$(echo "$DEVICE_RESPONSE" | jq -r '.device_code')
    USER_CODE=$(echo "$DEVICE_RESPONSE" | jq -r '.user_code')
    VERIFY_URL=$(echo "$DEVICE_RESPONSE" | jq -r '.verification_uri')
    
    echo ""
    echo -e "1. Open: ${CYAN}${VERIFY_URL}${NC}"
    echo -e "2. Code: ${GREEN}${USER_CODE}${NC}"
    echo ""
    echo -n "Waiting for auth..."
    
    INTERVAL=$(echo "$DEVICE_RESPONSE" | jq -r '.interval')
    while true; do
        sleep $((INTERVAL + 1))
        TOKEN_RESP=$(curl -s -X POST "https://github.com/login/oauth/access_token" \
            -H "Accept: application/json" \
            -d "client_id=${GITHUB_CLIENT_ID}&device_code=${DEVICE_CODE}&grant_type=urn:ietf:params:oauth:grant-type:device_code")
        
        ACCESS_TOKEN=$(echo "$TOKEN_RESP" | jq -r '.access_token')
        if [ -n "$ACCESS_TOKEN" ] && [ "$ACCESS_TOKEN" != "null" ]; then
            break
        fi
        echo -n "."
    done
    
    # Register with Backend
    USER_INFO=$(curl -s -H "Authorization: Bearer $ACCESS_TOKEN" "https://api.github.com/user")
    GITHUB_ID=$(echo "$USER_INFO" | jq -r '.id')
    GITHUB_USER=$(echo "$USER_INFO" | jq -r '.login')
    
    REG_RESP=$(curl -s -X POST "${CI5_API}/v1/identity/link" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $ACCESS_TOKEN" \
        -d "{\"hwid\": \"$HWID\", \"github_id\": $GITHUB_ID, \"github_user\": \"$GITHUB_USER\"}")
        
    STATUS=$(echo "$REG_RESP" | jq -r '.status')
    
    if [ "$STATUS" = "linked" ] || [ "$STATUS" = "already_linked" ]; then
        echo "$ACCESS_TOKEN" > "$CI5_TOKEN"
        chmod 600 "$CI5_TOKEN"
        echo -e "\n${GREEN}âœ… Identity Linked to @$GITHUB_USER${NC}"
    else
        echo -e "\n${RED}Link Failed: $STATUS${NC}"
        exit 1
    fi
}

cmd_verify() {
    check_identity
    HWID=$(get_hwid); TOKEN=$(get_token); CHALLENGE="${1:-}"
    [ -z "$CHALLENGE" ] && { echo "Usage: ci5 verify <code>"; exit 1; }
    [ -z "$TOKEN" ] && { echo "Not linked. Run 'ci5 link' first."; exit 1; }
    
    RESP=$(curl -s -X POST "${CI5_API}/v1/identity/verify" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $TOKEN" \
        -d "{\"hwid\": \"$HWID\", \"challenge\": \"$CHALLENGE\"}")
        
    if [ "$(echo "$RESP" | jq -r '.status')" = "verified" ]; then
        echo -e "${GREEN}âœ… Verified! Check your browser.${NC}"
    else
        echo -e "${RED}Failed: $(echo "$RESP" | jq -r '.error')${NC}"
    fi
}

cmd_rrul() {
    check_identity
    HWID=$(get_hwid); TOKEN=$(get_token)
    [ -z "$TOKEN" ] && { echo "Not linked. Run 'ci5 link' first."; exit 1; }
    
    USER_INFO=$(curl -s -H "Authorization: Bearer $TOKEN" "https://api.github.com/user")
    USERNAME=$(echo "$USER_INFO" | jq -r '.login')
    
    echo -e "${YELLOW}Starting Verified RRUL for @$USERNAME${NC}"
    if ! command -v flent >/dev/null; then echo "Install flent first."; exit 1; fi
    
    DATA="/tmp/rrul.gz"; JSON="/tmp/rrul.json"
    flent rrul -l 60 -H "netperf-eu.bufferbloat.net" -o "$DATA" >/dev/null 2>&1
    flent -i "$DATA" -f json > "$JSON" 2>/dev/null
    
    DL=$(jq '.results["TCP download sum"].avg' "$JSON")
    UL=$(jq '.results["TCP upload sum"].avg' "$JSON")
    LAT=$(jq '.results["Ping (ms) avg"].avg' "$JSON")
    
    echo -e "${GREEN}Result:${NC} D:${DL} U:${UL} Lat:${LAT}"
    echo "Copy this JSON for submission:"
    echo "{\"github\":\"$USERNAME\",\"hwid\":\"$HWID\",\"results\":{\"download\":$DL,\"upload\":$UL,\"latency\":$LAT}}"
    rm "$DATA" "$JSON"
}

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# MAIN ROUTING
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ensure_dependencies

case "${1:-}" in
    install|run) cmd_install "${2:-}" ;;
    update) update_registry ;;
    link) cmd_link ;;
    verify) cmd_verify "${2:-}" ;;
    rrul) cmd_rrul ;;
    *)
        echo "Ci5 CLI (Open/Verified)"
        echo "  ci5 install <cork>   Fetch & Run Cork (OPEN)"
        echo "  ci5 update           Update Registry (OPEN)"
        echo "  ci5 link             Link Identity (RESTRICTED)"
        echo "  ci5 verify <code>    Verify Browser (RESTRICTED)"
        echo "  ci5 rrul             Leaderboard Proof (RESTRICTED)"
        ;;
esac