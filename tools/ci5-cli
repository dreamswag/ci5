#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CI5 CLI â€” Hardware Identity & Community Bridge
# Version: 3.0-IDENTITY
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -euo pipefail

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION 
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

GITHUB_CLIENT_ID="Ov23liSwq6nuhqFog2xr" 
CI5_API="https://api.ci5.network"

# Local paths
CI5_IDENTITY="/etc/ci5/.hwid"
CI5_TOKEN="/etc/ci5/.github_token"
CI5_USER="/etc/ci5/.github_user"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COLORS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
DIM='\033[2m'
NC='\033[0m'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# DEPENDENCIES CHECK
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ensure_dependencies() {
    local missing=()
    
    for cmd in curl jq; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            missing+=("$cmd")
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        echo -e "${YELLOW}Installing dependencies: ${missing[*]}${NC}"
        
        if command -v opkg >/dev/null 2>&1; then
            opkg update >/dev/null 2>&1
            opkg install "${missing[@]}" >/dev/null 2>&1
        elif command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update -qq
            sudo apt-get install -y -qq "${missing[@]}"
        else
            echo -e "${RED}Error: Missing ${missing[*]}. Install manually.${NC}"
            exit 1
        fi
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# IDENTITY FUNCTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

get_hwid() {
    if [ -f "$CI5_IDENTITY" ]; then
        cat "$CI5_IDENTITY"
    else
        echo ""
    fi
}

get_token() {
    if [ -f "$CI5_TOKEN" ]; then
        cat "$CI5_TOKEN"
    else
        echo ""
    fi
}

get_user() {
    if [ -f "$CI5_USER" ]; then
        cat "$CI5_USER"
    else
        echo ""
    fi
}

check_identity() {
    local HWID
    HWID=$(get_hwid)
    
    if [ -z "$HWID" ]; then
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}  âŒ CI5 IDENTITY NOT INITIALIZED${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo "  Run the Ci5 installer first:"
        echo -e "  ${CYAN}curl -fsSL ci5.run/free | sh${NC}"
        echo ""
        exit 1
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COMMAND: LINK
# Links hardware identity to GitHub account
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cmd_link() {
    check_identity
    
    local HWID
    HWID=$(get_hwid)
    
    echo ""
    echo -e "${CYAN}ğŸ”— Ci5 Hardware Identity Linking${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo -e "HWID: ${GREEN}${HWID:0:8}...${HWID: -8}${NC}"
    echo ""
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Step 1: Request device code from GitHub
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    echo -e "${DIM}Requesting authorization code from GitHub...${NC}"
    
    local DEVICE_RESPONSE
    DEVICE_RESPONSE=$(curl -s -X POST "https://github.com/login/device/code" \
        -H "Accept: application/json" \
        -d "client_id=${GITHUB_CLIENT_ID}&scope=public_repo")
    
    local DEVICE_CODE USER_CODE VERIFY_URL INTERVAL
    DEVICE_CODE=$(echo "$DEVICE_RESPONSE" | jq -r '.device_code // empty')
    USER_CODE=$(echo "$DEVICE_RESPONSE" | jq -r '.user_code // empty')
    VERIFY_URL=$(echo "$DEVICE_RESPONSE" | jq -r '.verification_uri // empty')
    INTERVAL=$(echo "$DEVICE_RESPONSE" | jq -r '.interval // 5')
    
    if [ -z "$DEVICE_CODE" ] || [ "$DEVICE_CODE" = "null" ]; then
        echo -e "${RED}Error: Failed to get device code from GitHub${NC}"
        echo -e "${DIM}Response: $DEVICE_RESPONSE${NC}"
        exit 1
    fi
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Step 2: Show user code
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    echo ""
    echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo -e "  Open:  ${CYAN}${VERIFY_URL}${NC}"
    echo ""
    echo -e "  Code:  ${GREEN}${USER_CODE}${NC}"
    echo ""
    echo -e "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo -e "${DIM}Waiting for authorization (this may take a moment)...${NC}"
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Step 3: Poll for access token
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    local ACCESS_TOKEN=""
    local POLL_INTERVAL=$((INTERVAL + 1))
    local MAX_ATTEMPTS=60  # 5 minute timeout
    local ATTEMPT=0
    
    while [ -z "$ACCESS_TOKEN" ] && [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
        sleep "$POLL_INTERVAL"
        ATTEMPT=$((ATTEMPT + 1))
        
        local TOKEN_RESPONSE
        TOKEN_RESPONSE=$(curl -s -X POST "https://github.com/login/oauth/access_token" \
            -H "Accept: application/json" \
            -d "client_id=${GITHUB_CLIENT_ID}&device_code=${DEVICE_CODE}&grant_type=urn:ietf:params:oauth:grant-type:device_code")
        
        ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token // empty')
        local ERROR
        ERROR=$(echo "$TOKEN_RESPONSE" | jq -r '.error // empty')
        
        if [ -n "$ACCESS_TOKEN" ] && [ "$ACCESS_TOKEN" != "null" ]; then
            break
        fi
        
        if [ "$ERROR" = "slow_down" ]; then
            POLL_INTERVAL=$((POLL_INTERVAL + 5))
        elif [ "$ERROR" != "authorization_pending" ] && [ -n "$ERROR" ]; then
            echo -e "${RED}Error: $ERROR${NC}"
            exit 1
        fi
        
        echo -n "."
    done
    
    if [ -z "$ACCESS_TOKEN" ]; then
        echo ""
        echo -e "${RED}Timeout waiting for authorization${NC}"
        exit 1
    fi
    
    echo ""
    echo -e "${GREEN}âœ“ GitHub authorized${NC}"
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Step 4: Get GitHub user info
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    local USER_INFO GITHUB_USER GITHUB_ID
    USER_INFO=$(curl -s -H "Authorization: Bearer $ACCESS_TOKEN" "https://api.github.com/user")
    GITHUB_USER=$(echo "$USER_INFO" | jq -r '.login // empty')
    GITHUB_ID=$(echo "$USER_INFO" | jq -r '.id // empty')
    
    if [ -z "$GITHUB_USER" ] || [ "$GITHUB_USER" = "null" ]; then
        echo -e "${RED}Error: Failed to get GitHub user info${NC}"
        exit 1
    fi
    
    echo -e "  Account: ${CYAN}@${GITHUB_USER}${NC}"
    
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Step 5: Register with Ci5 backend
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    
    echo ""
    echo -e "${DIM}Registering with Ci5 Network...${NC}"
    
    local REGISTER_RESPONSE
    REGISTER_RESPONSE=$(curl -s -X POST "${CI5_API}/v1/identity/link" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $ACCESS_TOKEN" \
        -d "{\"hwid\": \"$HWID\", \"github_id\": \"$GITHUB_ID\", \"github_user\": \"$GITHUB_USER\"}")
    
    local STATUS
    STATUS=$(echo "$REGISTER_RESPONSE" | jq -r '.status // empty')
    
    case "$STATUS" in
        "linked")
            # Store credentials locally
            echo "$ACCESS_TOKEN" > "$CI5_TOKEN"
            chmod 600 "$CI5_TOKEN"
            echo "$GITHUB_USER" > "$CI5_USER"
            chmod 600 "$CI5_USER"
            
            echo ""
            echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${GREEN}  âœ… IDENTITY LINKED SUCCESSFULLY${NC}"
            echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo ""
            echo "  You are now a verified Ci5 citizen."
            echo ""
            echo "  â€¢ Post in ci5.network forums"
            echo "  â€¢ Rate corks in ci5.dev"
            echo "  â€¢ Submit verified RRUL results"
            echo ""
            ;;
            
        "banned")
            local REASON
            REASON=$(echo "$REGISTER_RESPONSE" | jq -r '.reason // "Hardware banned"')
            
            echo ""
            echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${RED}  â›” THIS HARDWARE IS BANNED${NC}"
            echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo ""
            echo "  Reason: $REASON"
            echo ""
            echo "  This decision is final."
            echo ""
            exit 1
            ;;
            
        "already_linked")
            local EXISTING
            EXISTING=$(echo "$REGISTER_RESPONSE" | jq -r '.existing_user // "unknown"')
            
            echo ""
            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${YELLOW}  âš ï¸  HARDWARE ALREADY LINKED${NC}"
            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo ""
            echo "  This hardware is linked to: @${EXISTING}"
            echo ""
            echo "  Each Pi can only be linked to one GitHub account."
            echo "  To transfer, contact support."
            echo ""
            exit 1
            ;;
            
        *)
            echo -e "${RED}Error: Registration failed${NC}"
            echo -e "${DIM}Response: $REGISTER_RESPONSE${NC}"
            exit 1
            ;;
    esac
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COMMAND: VERIFY
# Verifies a browser session challenge
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cmd_verify() {
    check_identity
    
    local HWID TOKEN CHALLENGE
    HWID=$(get_hwid)
    TOKEN=$(get_token)
    CHALLENGE="${1:-}"
    
    if [ -z "$CHALLENGE" ]; then
        echo ""
        echo -e "${RED}Usage: ci5 verify <challenge_code>${NC}"
        echo ""
        echo "  Get the challenge code from ci5.network or ci5.dev"
        echo "  when you try to post or vote."
        echo ""
        exit 1
    fi
    
    if [ -z "$TOKEN" ]; then
        echo ""
        echo -e "${RED}Error: Not linked to GitHub${NC}"
        echo ""
        echo "  Run 'ci5 link' first to connect your hardware"
        echo "  to your GitHub account."
        echo ""
        exit 1
    fi
    
    echo ""
    echo -e "${CYAN}ğŸ” Verifying hardware ownership...${NC}"
    echo ""
    
    local VERIFY_RESPONSE
    VERIFY_RESPONSE=$(curl -s -X POST "${CI5_API}/v1/identity/verify" \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $TOKEN" \
        -d "{\"hwid\": \"$HWID\", \"challenge\": \"$CHALLENGE\"}")
    
    local STATUS
    STATUS=$(echo "$VERIFY_RESPONSE" | jq -r '.status // empty')
    
    case "$STATUS" in
        "verified")
            echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${GREEN}  âœ… HARDWARE VERIFIED${NC}"
            echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo ""
            echo "  Return to your browser."
            echo "  Your session is now hardware-verified."
            echo ""
            ;;
            
        "banned")
            echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${RED}  â›” HARDWARE BANNED${NC}"
            echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            exit 1
            ;;
            
        *)
            local ERROR
            ERROR=$(echo "$VERIFY_RESPONSE" | jq -r '.error // "unknown_error"')
            local MESSAGE
            MESSAGE=$(echo "$VERIFY_RESPONSE" | jq -r '.message // ""')
            
            echo -e "${RED}âŒ Verification failed: $ERROR${NC}"
            [ -n "$MESSAGE" ] && echo -e "${DIM}$MESSAGE${NC}"
            exit 1
            ;;
    esac
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COMMAND: WHOAMI
# Shows current identity status
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cmd_whoami() {
    check_identity
    
    local HWID TOKEN USER
    HWID=$(get_hwid)
    TOKEN=$(get_token)
    USER=$(get_user)
    
    echo ""
    echo -e "${CYAN}ğŸ¦´ Ci5 Identity${NC}"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo -e "HWID:   ${GREEN}${HWID:0:16}...${NC}"
    echo ""
    
    if [ -n "$TOKEN" ]; then
        # Verify token is still valid
        local USER_INFO
        USER_INFO=$(curl -s -H "Authorization: Bearer $TOKEN" "https://api.github.com/user" 2>/dev/null)
        local GITHUB_USER
        GITHUB_USER=$(echo "$USER_INFO" | jq -r '.login // empty' 2>/dev/null)
        
        if [ -n "$GITHUB_USER" ] && [ "$GITHUB_USER" != "null" ]; then
            echo -e "GitHub: ${CYAN}@${GITHUB_USER}${NC}"
            echo -e "Status: ${GREEN}LINKED âœ“${NC}"
        else
            echo -e "GitHub: ${YELLOW}Token expired${NC}"
            echo -e "Status: ${YELLOW}NEEDS RELINK${NC}"
            echo ""
            echo "  Run 'ci5 link' to reconnect"
        fi
    else
        echo -e "GitHub: ${YELLOW}Not linked${NC}"
        echo -e "Status: ${YELLOW}UNLINKED${NC}"
        echo ""
        echo "  Run 'ci5 link' to connect your GitHub account"
    fi
    echo ""
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# COMMAND: UNLINK
# Removes local credentials (does not delete server-side link)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cmd_unlink() {
    echo ""
    echo -e "${YELLOW}âš ï¸  This will remove your local GitHub credentials.${NC}"
    echo ""
    read -p "Continue? [y/N] " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        rm -f "$CI5_TOKEN" "$CI5_USER"
        echo -e "${GREEN}Local credentials removed.${NC}"
        echo ""
        echo "  Your hardware is still registered server-side."
        echo "  Run 'ci5 link' to reconnect."
        echo ""
    else
        echo "Cancelled."
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MAIN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ensure_dependencies

case "${1:-}" in
    link)
        cmd_link
        ;;
    verify)
        cmd_verify "${2:-}"
        ;;
    whoami|id|identity)
        cmd_whoami
        ;;
    unlink)
        cmd_unlink
        ;;
    -h|--help|help)
        echo ""
        echo "Ci5 CLI (v3.0-IDENTITY)"
        echo ""
        echo "Usage: ci5 <command>"
        echo ""
        echo "Identity Commands:"
        echo "  link              Link this hardware to your GitHub account"
        echo "  verify <code>     Verify a browser session challenge"
        echo "  whoami            Show current identity status"
        echo "  unlink            Remove local GitHub credentials"
        echo ""
        echo "Run 'ci5 link' first to join the Ci5 community."
        echo ""
        ;;
    *)
        echo ""
        echo "Ci5 CLI â€” Run 'ci5 --help' for usage"
        echo ""
        cmd_whoami
        ;;
esac
