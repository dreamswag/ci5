#!/bin/bash
# ‚õ©Ô∏è Ci5 CLI (v2.1-RRUL-ASH)
# The Bridge: Identity (ASH) + Verification (RRUL) + Management (Corks)

# --- CONFIGURATION ---
CLIENT_ID="Ov23lisWq6nuhqFog2xr"  # Your Shared Ecosystem Client ID
AUTH_FILE="/etc/ci5/auth.token"
SOURCES_FILE="/etc/ci5/sources.list"
CACHE_FILE="/tmp/ci5_registry_composite.json"
ASH_SALT="ci5-network-verification-v1" # Changing this rotates all identities
OFFICIAL_REGISTRY="https://ci5.dev/corks.json"

# --- COLORS ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# --- DEPENDENCIES ---
ensure_dependencies() {
    for cmd in jq curl sha256sum; do
        if ! command -v $cmd >/dev/null; then
            echo "Installing dependency: $cmd..."
            if command -v opkg >/dev/null; then
                opkg update && opkg install $cmd coreutils-sha256sum >/dev/null
            elif command -v apt-get >/dev/null; then
                sudo apt-get update && sudo apt-get install -y $cmd >/dev/null
            else
                echo -e "${RED}Error: Missing $cmd. Install manually.${NC}"
                exit 1
            fi
        fi
    done
}

# --- IDENTITY (ci5-ASH) ---
get_raw_serial() {
    # Try cpuinfo first (Pi/Embedded), fallback to system product uuid (x86), fallback to mac
    grep -i "serial" /proc/cpuinfo 2>/dev/null | awk '{print $3}' | head -1 || \
    cat /sys/class/dmi/id/product_uuid 2>/dev/null || \
    cat /sys/class/net/eth0/address 2>/dev/null || \
    echo "UNKNOWN_HARDWARE"
}

get_ash() {
    # ANONYMOUS SALTED HASH
    # The server NEVER sees the raw serial. Only this hash.
    SERIAL=$(get_raw_serial)
    echo -n "${SERIAL}${ASH_SALT}" | sha256sum | awk '{print $1}'
}

# --- REGISTRY FUNCTIONS ---
init_sources() {
    if [ ! -d "/etc/ci5" ]; then
        if [ "$EUID" -ne 0 ]; then
            sudo mkdir -p /etc/ci5 && sudo chown $USER /etc/ci5
        else
            mkdir -p /etc/ci5
        fi
    fi
    [ ! -f "$SOURCES_FILE" ] && echo "$OFFICIAL_REGISTRY" > "$SOURCES_FILE"
}

update_registry() {
    init_sources
    echo "üîÑ Fetching Corks..."
    echo '{"official":{}, "community":{}}' > "$CACHE_FILE"
    while IFS= read -r URL || [ -n "$URL" ]; do
        [[ "$URL" =~ ^#.*$ ]] || [[ -z "$URL" ]] && continue
        FETCHED=$(curl -s --max-time 5 "$URL")
        if echo "$FETCHED" | jq empty >/dev/null 2>&1; then
            jq -s '.[0] * ..[1]' "$CACHE_FILE" <(echo "$FETCHED") > "${CACHE_FILE}.tmp" && mv "${CACHE_FILE}.tmp" "$CACHE_FILE"
        fi
    done < "$SOURCES_FILE"
    echo -e "${GREEN}Registry Updated.${NC}"
}

# --- AUTHENTICATION ---
cmd_login() {
    echo "üîê Initiating Device Flow..."
    RESPONSE=$(curl -s -X POST -H "Accept: application/json" -d "client_id=$CLIENT_ID" -d "scope=read:user" "https://github.com/login/device/code")
    
    DEVICE_CODE=$(echo $RESPONSE | jq -r .device_code)
    USER_CODE=$(echo $RESPONSE | jq -r .user_code)
    VERIFY_URL=$(echo $RESPONSE | jq -r .verification_uri)
    INTERVAL=$(echo $RESPONSE | jq -r .interval)

    [ "$DEVICE_CODE" == "null" ] && { echo -e "${RED}GitHub Connection Failed${NC}"; exit 1; }

    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  ACTION REQUIRED:${NC}"
    echo "1. Open: ${GREEN}$VERIFY_URL${NC}"
    echo "2. Code: ${GREEN}$USER_CODE${NC}"
    echo ""
    echo -n "Waiting..."

    while true; do
        sleep $((INTERVAL + 1))
        echo -n "."
        TOKEN_RESP=$(curl -s -X POST -H "Accept: application/json" -d "client_id=$CLIENT_ID" -d "device_code=$DEVICE_CODE" -d "grant_type=urn:ietf:params:oauth:grant-type:device_code" "https://github.com/login/oauth/access_token")
        ACCESS_TOKEN=$(echo $TOKEN_RESP | jq -r .access_token)
        
        if [ "$ACCESS_TOKEN" != "null" ]; then
            mkdir -p $(dirname $AUTH_FILE)
            echo "$ACCESS_TOKEN" > "$AUTH_FILE"
            chmod 600 "$AUTH_FILE"
            echo ""
            echo -e "${GREEN}Authenticated!${NC}"
            echo "Identity: $(get_ash)"
            break
        fi
    done
}

# --- VERIFIED RRUL (THE "PROOF") ---
cmd_rrul() {
    CHALLENGE="$1"
    
    if [ ! -f "$AUTH_FILE" ]; then
        echo -e "${RED}Error: Not logged in.${NC} Run 'ci5 login' first."
        exit 1
    fi
    
    # 1. Verify Authentication
    TOKEN=$(cat "$AUTH_FILE")
    USER_JSON=$(curl -s -H "Authorization: Bearer $TOKEN" https://api.github.com/user)
    USERNAME=$(echo $USER_JSON | jq -r .login)
    
    if [ "$USERNAME" == "null" ]; then
        echo -e "${RED}Session expired.${NC} Run 'ci5 login' again."
        exit 1
    fi
    
    echo -e "üêπ ${YELLOW}Starting Verified RRUL Protocol${NC}"
    echo "   Pilot: $USERNAME"
    echo "   AshID: $(get_ash | cut -c1-8)..."
    echo "   Token: ${CHALLENGE:-'Self-Test'}"
    echo ""
    
    # 2. Check for Flent
    if ! command -v flent >/dev/null; then
        echo -e "${RED}Error: 'flent' not found.${NC} Install it first."
        exit 1
    fi
    
    # 3. Run RRUL (The "Hardware Grab")
    # We use a standard target (e.g., netperf-eu.bufferbloat.net) or local
    TARGET="netperf-eu.bufferbloat.net" # Default public target
    
    echo "Running 60s RRUL load test against $TARGET..."
    DATA_FILE="/tmp/rrul_${USERNAME}_$(date +%s).flent.gz"
    JSON_FILE="/tmp/rrul_${USERNAME}_$(date +%s).json"
    
    # Run Flent (Quietly)
    flent rrul -l 60 -H "$TARGET" -t "Ci5 Verified: $USERNAME" -o "$DATA_FILE" >/dev/null 2>&1
    
    # Export JSON Summary
    flent -i "$DATA_FILE" -f json > "$JSON_FILE" 2>/dev/null
    
    # 4. Construct Verified Payload
    # This combines the Github Identity + Hardware Hash + Performance Data
    # This is the "Verification Blob" expected by ci5.network
    
    DL=$(jq '.results["TCP download sum"].avg' "$JSON_FILE")
    UL=$(jq '.results["TCP upload sum"].avg' "$JSON_FILE")
    LAT=$(jq '.results["Ping (ms) avg"].avg' "$JSON_FILE")
    
    echo ""
    echo -e "${GREEN}‚úÖ TEST COMPLETE${NC}"
    echo "---------------------------------------------------"
    echo "   Throughput: ${DL} Mbps / ${UL} Mbps"
    echo "   Latency:    ${LAT} ms"
    echo "---------------------------------------------------"
    echo ""
    echo "üìã Copy this JSON payload to the Submit form:"
    echo ""
    
    # Generate the JSON Payload
    cat <<EOF
{
  "github": "$USERNAME",
  "hw_ash": "$(get_ash)",
  "challenge": "$CHALLENGE",
  "results": {
    "download": $DL,
    "upload": $UL,
    "latency": $LAT
  },
  "signature": "VERIFIED_CLIENT_V2.1"
}
EOF
    
    # Cleanup
    rm "$JSON_FILE" "$DATA_FILE"
}

# --- INSTALLATION (Legacy) ---
cmd_run() {
    # [Code from previous step for installing corks...]
    echo "Installing Cork $1..." 
}

# --- MAIN ---
ensure_dependencies

case "$1" in
    login) cmd_login ;;
    rrul)  cmd_rrul "$2" ;;
    update) update_registry ;;
    repo)   
        if [ "$2" == "add" ]; then
             echo "$3" >> "$SOURCES_FILE"
        fi
        ;;
    *)
        echo "‚õ©Ô∏è  Ci5 CLI (v2.1)"
        echo "Usage:"
        echo "  ci5 login           - Authenticate (GitHub Device Flow)"
        echo "  ci5 rrul [token]    - Run Verified Performance Gauntlet"
        echo "  ci5 update          - Refresh Cork registry"
        ;;
esac